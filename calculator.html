<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <!-- 作者:Leo-YYY -->
    <title>JavaScript实现的简单计算器</title>
    <link rel="stylesheet" type="text/css" href="css/mr-style.css">
    <script>
        let num = 0;
        let result = 0;
        let operate = 0; // 判断输入状态的标志
        let calcul = 0; // 判断计算状态的标志
        let strlong = "0";
        let point = []; // 小数点状态
        let pointload = 0; // 小数点位置

        function command(num) {
            strlong = strlong === "0" ? String(num) : strlong + String(num); // 如果为0，则直接赋值，否则追加字符串

            if (calcul !== 0) { //如果计算器处于计算状态，则调用自动计算函数
                autoequal();
            }

            document.calculator.numScreen1.value = strlong; // 显示当前数字
            operate = 0; // 重置输入状态
        }

        /*验证是否为0*/
        function dzero(zero) {
            if (strlong === "0") {
                strlong = "0";
            } else if (!(strlong[strlong.length - 2] >= '0' && strlong[strlong.length - 2] <= '9') && strlong[strlong
                    .length - 1] == '0' && strlong[strlong.length - 2] != '.') { //如果倒数第二位是运算符，倒数第一位是0，则退出函数，不填0
                return;
            } else if(!(strlong[strlong.length - 1] >= '0' && strlong[strlong.length - 1] <= '9') && strlong[strlong.length - 1] != '.') {
                strlong += "0";
            } else {
                if (zero === "0") {
                    strlong += "0";
                } else if (zero === "00") {
                    strlong += "00";
                }
            }
            if (calcul !== 0) { //如果计算器处于计算状态，则调用自动计算函数
                autoequal();
            }

            document.calculator.numScreen1.value = strlong; // 刷新显示
            operate = 0;
        }

        /*验证是否有小数点*/
        function dot() {

            if (point[pointload] == null && strlong[strlong.length - 1] >= '0' && strlong[strlong.length - 1] <= '9') {
                strlong += ".";
                operate = 0;
                point[pointload] = 1;
            }
            document.calculator.numScreen1.value = strlong; // 刷新显示
        }

        /*退格*/
        function del() {
            strlong = document.calculator.numScreen1.value;
            if (strlong[strlong.length - 1] === ".") {
                point[pointload] = null;
                //pointc--;
            } else if (!(strlong[strlong.length - 1] >= '0' && strlong[strlong.length - 1] <=
                    '9') && (strlong[strlong.length - 2] >= '0' && strlong[strlong.length - 2] <=
                    '9')) {
                point[pointload] = null;
                pointload--;
            }

            strlong = strlong.slice(0, -1);
            strlong = strlong || "0";
            document.calculator.numScreen1.value = strlong;

            if (strlong[strlong.length - 1] >= '0' && strlong[strlong.length - 1] <= '9' && calcul !== 0) {
                operate = 0;
            }

            if (strlong >= 0 || strlong <= 0) {
                calcul = 0;
                operate = 0;
                return;
            }

            autoequal();
        }

        /*清除数据*/
        function clearscreen() {
            strlong = "0";
            result = 0;
            calcul = 0;
            operate = 0;
            for (let i = 0; i <= point.length - 1; i++) {
                point[i] = null;
            }
            pointload = 0;
            document.calculator.numScreen1.value = "0";
            document.calculator.numScreen2.value = "";
        }

        /*减法*/
        function minus() {
            if (operate === 0) {
                if (strlong === "0") {
                    strlong = "-";
                    calcul = 6;
                } else {
                    strlong += "-";
                    calcul = 1;
                }
                operate = 1;
                pointload++;
            } else if ((calcul === 3 || calcul === 4 || calcul === 5) && operate !== 2) {
                strlong += "-";
                operate = 2;
            } else if (operate !== 2) {
                strlong = strlong.slice(0, -1) + "-";
                calcul = 1;
                operate = 1;
                pointload++;
            }

            document.calculator.numScreen1.value = strlong; // 刷新显示
        }

        /*加法*/
        function plus() {
            if (strlong === "0" || strlong === "-") {
                operate = 0;
                return;
            } else if (operate === 0) {
                strlong += "+";
            } else if (operate === 2) {
                strlong = strlong.slice(0, -2) + "+";
            } else {
                strlong = strlong.slice(0, -1) + "+";
            }

            document.calculator.numScreen1.value = strlong; // 刷新显示
            operate = 1; // 更改输入状态
            calcul = 2; // 更改计算状态
            pointload++;
        }

        /*乘法*/
        function times() {
            if (strlong === "0" || strlong === "-") {
                operate = 0;
                return;
            } else if (operate === 0) {
                strlong += "*";
            } else if (operate === 2) {
                strlong = strlong.slice(0, -2) + "*";
            } else {
                strlong = strlong.slice(0, -1) + "*";
            }

            document.calculator.numScreen1.value = strlong; // 刷新显示
            operate = 1;
            calcul = 3;
            pointload++;
        }

        /*除法*/
        function divide() {
            if (strlong === "0" || strlong === "-") {
                operate = 0;
                return;
            } else if (operate === 0) {
                strlong += "/";
            } else if (operate === 2) {
                strlong = strlong.slice(0, -2) + "/";
            } else {
                strlong = strlong.slice(0, -1) + "/";
            }

            document.calculator.numScreen1.value = strlong; // 刷新显示
            operate = 1;
            calcul = 4;
            pointload++;
        }

        /*求余*/
        function persent() {
            if (strlong === "0" || strlong === "-") {
                operate = 0;
                return;
            } else if (operate === 0) {
                strlong += "%";
            } else if (operate === 2) {
                strlong = strlong.slice(0, -2) + "%";
            } else {
                strlong = strlong.slice(0, -1) + "%";
            }

            document.calculator.numScreen1.value = strlong; // 刷新显示
            operate = 1;
            calcul = 5;
            pointload++;
        }

        /*等于*/
        function equal() {
            if (strlong[strlong.length - 1] >= '0' && strlong[strlong.length - 1] <= '9') { //如果最后一个字符是数字，是数字直接进行计算
                result = calculate(strlong);
            } else if (strlong.slice(0, -1) <= 0 || strlong.slice(0, -1) >= 0) { //如果减去最后一个字符的字符串是数字，则退出函数
                return;
            } else if (!(strlong[strlong.length - 2] >= '0' && strlong[strlong.length - 2] <= '9') && !(strlong.slice(0,
                    -2) <= 0 || strlong.slice(0, -2) >= 0)) { //如果减去最后两个字符的字符串是数字，且倒数第二个字符串不是数字，则计算减去最后两个字符的字符串
                result = calculate(strlong.slice(0, -2));
            } else if (!(strlong.slice(0, -1) <= 0 || strlong.slice(0, -1) >=
                    0)) { //如果减去最后一个字符的字符串是数字，且最后一个字符串不是数字，则计算减去最后一个字符的字符串
                result = calculate(strlong.slice(0, -1));
            }

            document.calculator.numScreen1.value = result;
            document.calculator.numScreen2.value = "";
            strlong = document.calculator.numScreen1.value;
            operate = 0;
            calcul = 0;
            pointload = 0;

            let flag = 0;
            for (let i = 0; i < strlong.length; i++) { // 判断是否已经有一个点号
                if (strlong[i] === ".") {
                    point[pointload] = 1;
                    for (let j = 1; j <= point.length - 1; j++) {
                        point[j] = null;
                    }
                    flag = 1;
                    break;
                }
            }
            if (flag === 0) {
                for (let j = 0; j <= point.length - 1; j++) {
                    point[j] = null;
                }
            }
            if (document.calculator.numScreen1.value === "Infinity") {
                alert('被除数不能为零！');
                document.calculator.numScreen1.value = "0";
                strlong = "0";
            }
            if (document.calculator.numScreen1.value == "NaN") {
                document.calculator.numScreen1.value = "0";
                strlong = "0";
            }
        }

        /*自动计算*/
        function autoequal() {
            if (!(strlong[strlong.length - 1] >= '0' && strlong[strlong.length - 1] <= '9') && (strlong.slice(0, -1) <=
                    0 || strlong.slice(0, -1) >= 0)) { //如果最后一个字符不是数字，减去最后一个字符后整个字符串都是数字，则不进行计算
                document.calculator.numScreen2.value = "";
                operate = 1
            } else if (!(strlong[strlong.length - 1] >= '0' && strlong[strlong.length - 1] <= '9') && !(strlong[strlong
                    .length - 2] >= '0' && strlong[strlong.length - 2] <= '9') && !(strlong.slice(0, -2) <= 0 || strlong
                    .slice(0, -2) >= 0)) { //如果最后一个字符不是数字，且倒数第二个字符也不是数字，则计算减去后面两个字符后的字符串
                result = calculate(strlong.slice(0, -2));
                document.calculator.numScreen2.value = result;
            } else if (!(strlong[strlong.length - 1] >= '0' && strlong[strlong.length - 1] <= '9') && !(strlong.slice(0,
                    -1) <= 0 || strlong.slice(0, -1) >= 0)) { //如果最后一个字符不是数字，减去最后一个字符后整个字符串也不是数字，则计算减去最后一个字符后的字符串
                result = calculate(strlong.slice(0, -1));
                document.calculator.numScreen2.value = result;
                operate = 1;
            } else { //直接计算整个字符串
                result = calculate(strlong);
                document.calculator.numScreen2.value = result;
                operate = 0;
                if (document.calculator.numScreen2.value == Infinity) {
                    document.calculator.numScreen2.value = "错误";
                }
                if (document.calculator.numScreen2.value == "NaN") {
                    document.calculator.numScreen2.value = "0";
                }
            }


        }

        /*计算*/
        function calculate(expression) {
            return new Function('return ' + expression)(); //将字符串转换为函数并执行
        }
    </script>
</head>

<body>
    <div id="mr-calculator">
        <div id="calcu-head">
            <h6>简单的计算器</h6>
        </div>
        <form name="calculator" action="" method="get">
            <div id="calcu-screen">
                <!--显示窗口，避免键盘输入-->
                <input type="text" name="numScreen1" class="screen" value="0" onfocus="this.blur();" />
                <input type="text" name="numScreen2" class="screen" value="" onfocus="this.blur();" />
            </div>
            <div>
                <ul>
                    <!--显示计算按钮-->
                    <li onclick="command(7)">7</li>
                    <li onclick="command(8)">8</li>
                    <li onclick="command(9)">9</li>
                    <li class="tool" onclick="del()">←</li>
                    <li class="tool" onclick="clearscreen()">C</li>
                    <li onclick="command(4)">4</li>
                    <li onclick="command(5)">5</li>
                    <li onclick="command(6)">6</li>
                    <li class="tool" onclick="times()">×</li>
                    <li class="tool" onclick="divide()">÷</li>
                    <li onclick="command(1)">1</li>
                    <li onclick="command(2)">2</li>
                    <li onclick="command(3)">3</li>
                    <li class="tool" onclick="plus()">+</li>
                    <li class="tool" onclick="minus()">-</li>
                    <li onclick="dzero('0')">0</li>
                    <li onclick="dzero('00')">00</li>
                    <li onclick="dot()">.</li>
                    <li class="tool" onclick="persent()">%</li>
                    <li class="tool" onclick="equal()">=</li>
                </ul>
            </div>
        </form>
    </div>
</body>

</html>